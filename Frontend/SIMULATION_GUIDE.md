# 模擬移動功能說明

## 功能概述

前端現在支援智能的位置模擬移動功能，只有在離開已知路段範圍時才會重新呼叫後端 API，大幅減少不必要的 API 請求。

## 工作原理

### 1. 路段範圍檢測
- 後端 API 會回傳一個路段列表（`roads`），每個路段包含多個節點（`nodes`）
- 前端會計算當前位置到所有已知路段的最短距離
- 如果距離小於 30 公尺，視為在已知路段範圍內

### 2. 智能 API 呼叫
- **在已知路段內**：只更新地圖位置，不呼叫 API
- **離開已知路段**：自動重新呼叫 API 載入新的路段資料

### 3. 模擬移動參數
- **移動間隔**：每 2 秒移動一次
- **移動距離**：
  - 往北：0.0001 度（約 11 公尺）
  - 往東：0.00005 度（約 5.5 公尺）
- **檢測閾值**：30 公尺

## 使用方式

### 開始模擬移動
1. 點擊右下角的「模擬移動」按鈕（藍紫色，播放圖示）
2. 系統會開始自動移動，並在 console 顯示移動資訊
3. 按鈕會變成黃色的「停止移動」

### 停止模擬移動
1. 點擊「停止移動」按鈕（黃色，暫停圖示）
2. 模擬移動會立即停止

### Console 訊息說明

#### 在已知路段內
```
📍 位置更新: 25.033100, 121.565450 - 在 市府路 附近 (15.3m)
```

#### 離開已知路段
```
🚶 已離開已知路段範圍，需要重新載入
📍 位置更新: 25.034500, 121.566200 - 重新載入資料
🌐 呼叫後端 API: http://127.0.0.1:5001/get_safety_data?...
✅ 資料載入完成
```

## 調整參數

如果需要調整移動行為，可以修改 `Frontend/src/App.tsx` 中的參數：

### 移動速度和方向
```typescript
const newLat = prev[0] + 0.0001; // 往北移動（增加緯度）
const newLng = prev[1] + 0.00005; // 往東移動（增加經度）
```

### 移動間隔
```typescript
}, 2000); // 2000 毫秒 = 2 秒
```

### 檢測閾值
在 `updateLocationAndLoadData` 函數中：
```typescript
isWithinKnownRoads(lat, lng, roadSafetyData.roads, 30) // 30 公尺
```

## 技術細節

### 距離計算
使用 Haversine 公式計算地球表面兩點之間的實際距離（公尺）。

### 點到線段距離
計算當前位置到路段（由多個節點組成的折線）的最短距離，考慮：
- 點到線段端點的距離
- 點到線段投影點的距離

### 效能優化
- 只在必要時呼叫 API
- 減少網路請求次數
- 降低後端負載
- 提升使用者體驗

## 測試建議

1. **初始載入**：確認 App 啟動時正確載入初始位置的資料
2. **路段內移動**：觀察在同一路段內移動時不會重複呼叫 API
3. **跨路段移動**：確認離開已知路段時會自動載入新資料
4. **手動重新載入**：點擊「重新載入」按鈕可強制重新載入當前位置的資料

## 相關檔案

- `Frontend/src/App.tsx` - 主要邏輯
- `Frontend/src/utils/roadSegmentChecker.ts` - 路段檢測工具
- `Frontend/src/utils/roadSafetyDataLoader.ts` - 道路安全資料載入
- `Frontend/src/utils/safetyDataLoader.ts` - 安全資料載入
